const puppeteer = require('puppeteer');

const proNumbers = [
    "12111197",
    "12110536",
    "12110535",
    "12110534",
    "12110533",
    "12110532",
    "12110531",
    "12110529",
    "12110528",
    "12110526",
    "12110522",
    "12110520",
    "12110519",
    "12110515",
    "12110514",
    "12110513",
    "12110512",
    "12110510",
    "12110509",
    "12110508",
    "12110505",
    "12110496",
    "12110495",
    "12110494",
    "12110493",
    "12110492",
    "12110491",
    "12109294",
    "12109290",
    "12109289",
    "12106707",
    "12106679",
    "12106675",
    "12105995",
    "12105968",
    "12105643",
    "12104676",
    "12104633",
    "12104203",
    "12104146",
    "12104119",
    "12104041",
    "12103693",
    "12103213",
    "12103212",
    "12103211",
    "12103145",
    "12102768",
    "12102712",
    "12102711",
    "12102710",
    "12102662",
    "12102660",
    "12102659",
    "12102658",
    "12102653",
    "12102644",
    "12102643",
    "12102639",
    "12102638",
    "12102637",
    "12102636",
    "12102630",
    "12102618",
    "12102615",
    "12102613",
    "12102610",
    "12102607",
    "12102605",
    "12102604",
    "12102599",
    "12102396",
    "12102194",
    "12101759",
    "12101757",
    "12101742",
    "12101663",
    "12101642",
    "12101462",
    "12101461",
    "12101460",
    "12101459",
    "12101458",
    "12101457",
    "12101456",
    "12101455",
    "12101454",
    "12101452",
    "12101451",
    "12101450",
    "12101194",
    "12101192",
    "12101185",
    "12101184",
    "12101182",
    "12101177",
    "12101157",
    "12100608",
    "12098364",
    "12097897",
    "12097562",
    "12097480",
    "12097426",
    "12097423",
    "12097422",
    "12097393",
    "12097391",
    "12097319",
    "12097315",
    "12097164",
    "12097163",
    "12097162",
    "12097161",
    "12097136",
    "12097085",
    "12097083",
    "12097040",
    "12097039",
    "12097038",
    "12097024",
    "12096981",
    "12096980",
    "12096979",
    "12096978",
    "12096976",
    "12096974",
    "12096957",
    "12096952",
    "12096931",
    "12096928",
    "12096888",
    "12096877",
    "12096854",
    "12096833",
    "12096832",
    "12096818",
    "12096816",
    "12096802",
    "12096799",
    "12096797",
    "12096795",
    "12096709",
    "12096704",
    "12096680",
    "12096679",
    "12096678",
    "12096677",
    "12096664",
    "12096656",
    "12096640",
    "12096639",
    "12096637",
    "12096636",
    "12096605",
    "12096568",
    "12096561",
    "12096376",
    "12096231",
    "12096229",
    "12096212",
    "12096206",
    "12096191",
    "12096176",
    "12096169",
    "12096162",
    "12096152",
    "12096052",
    "12096050",
    "12096033",
    "12095889",
    "12095821",
    "12095817",
    "12095815",
    "12095801",
    "12095798",
    "12095697",
    "12095656",
    "12095642",
    "12095415",
    "12095368",
    "12095363",
    "12095355",
    "12095354",
    "12095353",
    "12095352",
    "12095242",
    "12094904",
    "12094895",
    "12094894",
    "12094893",
    "12094892",
    "12094714",
    "12094713",
    "12094712",
    "12094649",
    "12094627",
    "12094626",
    "12094625",
    "12094620",
    "12094463",
    "12094462",
    "12094270",
    "12094228",
    "12094217",
    "12094089",
    "12094067",
    "12094066",
    "12093778",
    "12093688",
    "12093681",
    "12093428",
    "12093427",
    "12093370",
    "12093368",
    "12093332",
    "12093326",
    "12093320",
    "12093275",
    "12093235",
    "12093161",
    "12093126",
    "12092881",
    "12092880",
    "12092879",
    "12092821",
    "12092792",
    "12092788",
    "12092569",
    "12092568",
    "12092558",
    "12092525",
    "12092524",
    "12092022",
    "12091480",
    "12091380",
    "12091309",
    "12091285",
    "12091220",
    "12091218",
    "12091204",
    "12091139",
    "12091127",
    "12091126",
    "12091111",
    "12091053",
    "12091003",
    "12091002",
    "12091001",
    "12091000",
    "12090999"
];

const searchAndScreenshot = async (page, proNumber, i) => {
    //0. Click on PO Search
    await page.waitForSelector('a[title=PO]', { visible: true });
    await page.click('a[title=PO]');

    //1. Iframe PO search
    await page.waitForSelector('iframe[title=OTM]', { visible: true });
    const elementHandle1 = await page.$(
        'iframe[title=OTM]',
    );
    const frame = await elementHandle1.contentFrame();
    await frame.waitForSelector('input[name="srShipmentRefnumValue69"]', { visible: true });
    await frame.type('input[name="srShipmentRefnumValue69"]', proNumber);
    await frame.waitForSelector('a[name="search_button"]', { visible: true });

    await frame.click('a[name="search_button"]');

    //2. Results Page
    const elementHandle2 = await page.$(
        'iframe[title=OTM]',
    );
    const frame2 = await elementHandle2.contentFrame();
    await frame2.waitForSelector('table.hdLine  span.text.bold.nw', { visible: true });
    await frame2.$x('//span.text.bold.nw[contains(text(), "Total Found")]');
    const resultsAmount = await frame2.$eval('span.text.bold.nw + span.text.nw', (node) => node.innerText)
    console.log('Total results found:', resultsAmount);
    const found = (resultsAmount > 0);
    //3. Take the screenshot
    await page.screenshot({ path: `${i}_${proNumber}${!found ? `_not_found` : ''}.png` });

    //4. Go home
    await page.click('a[title="Home"]');

    return true
};

(async () => {
    const browser = await puppeteer.launch({ 
        headless: false,
        defaultViewport: null,
        args: ['--start-maximized'] 
    });
    const page = await browser.newPage();

    //Login
    await page.goto('https://qa.myhubgroup.com/');

    await page.waitForSelector('input[name=username]');
    await page.type('input[name=username]', "CSK_SAW");
    await page.type('input[name=userpassword]', "welcome");
    await page.keyboard.press('Enter');

    //For each Pro Number loop
    for(let i = 0; i < proNumbers.length; i++) {
        await searchAndScreenshot(page, proNumbers[i], i);
    }

    await browser.close();
})();